import requests
from itertools import izip
from BeautifulSoup import BeautifulSoup

from xbmctorrent import plugin
from xbmctorrent.scrapers import scraper
from xbmctorrent.common import url_for_magnet
from xbmctorrent.ga import tracked

@scraper("EZTV", "http://ezimg.it/s/1/1/eztv-logo-small.png")
@plugin.route("/eztv")
@tracked
def eztv_index():
    response = requests.get("https://eztv.it/showlist/")
    soup = BeautifulSoup(response.text)
    nodes = soup.findAll("a", "thread_link")

    for node in nodes:
        show_id, show_name = node["href"].split("/")[2:4]
        yield {
            "label": node.text,
            "path": plugin.url_for("eztv_get_show", show_id=show_id, show_name=show_name),
            "thumbnail": "http://ezimg.it/t/%s/main.png" % show_name.replace("-", "_"),
            "is_playable": False,
        }


@plugin.route("/eztv/shows/<show_id>/<show_name>")
@tracked
def eztv_get_show(show_id, show_name):
    response = requests.get("https://eztv.it/shows/%s/%s" % (show_id, show_name))
    soup = BeautifulSoup(response.text)
    for node_text, node_magnet in izip(soup.findAll("a", "epinfo"), soup.findAll("a", "magnet")):
        stream_info = {}
        if "x264" in node_text.text:
            stream_info["codec"] = "h264"
        if "720p" in node_text.text:
            stream_info["width"] = 1280
            stream_info["height"] = 720
        if "1080p" in node_text.text:
            stream_info["width"] = 1920
            stream_info["height"] = 1080
        yield {
            "label": node_text.text,
            "path": url_for_magnet(node_magnet["href"]),
            "is_playable": True,
            "stream_info": stream_info,
        }
